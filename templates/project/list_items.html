{% extends 'layouts/base.html' %}

{% block title %} Dashboard {% endblock title %}

{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

<table class="table table-bordered">

    <div class="m-2">
        <h3>Items for Project: {{ project.name }}</h3>
        <a href="{{ url_for('project_blueprint.index') }}" class="btn btn-primary mb-3">Back to Projects</a>
        <a href="{{ url_for('projectItem_blueprint.add_items', project_id=project.id) }}"
            class="btn btn-primary mb-3">Add item</a>
    </div>
    <thead>
        <tr>
            <th>Image</th>
            <th>Description</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="itemsTable">
        {% for item in project_items %}
        <tr>
            <td>
                <img src="{{ url_for('static', filename='uploads/' ~ item.image) }}" alt="Item Image"
                    class="img-thumbnail" style="width: 100px; height: 100px;">
            </td>
            <td>
                <p style="white-space: normal; word-wrap: break-word;">{{ item.description }}</p>
            </td>
            <td>
                <form action="/projectItem/{{ item.project_id }}/deleteItem/{{ item.id }}" method="POST"
                    style="display:inline;">
                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                </form>
                <a href="{{ url_for('projectItem_blueprint.update_item', item_id=item.id) }}"
                    type="button" class="btn btn-sm btn-primary edit-item-btn">Edit</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>


{% endblock content %}

{% block javascripts %}
<script>
    let itemIndex = 0;

    function createItemForm(index) {
        return `
    <div class="border rounded p-3 mb-3 item-block">
        <div class="form-group">
            <label>Image</label>
            <input type="file" name="items[${index}][image]" class="form-control-file image-input" required>
            <img src="#" class="img-thumbnail mt-2 img-preview" style="width: 200px; display: none;" />
        </div>
        <div class="form-group">
            <label>Description</label>
            <textarea name="items[${index}][description]" class="form-control" required></textarea>
        </div>
        <button type="button" class="btn btn-sm btn-danger remove-item-btn">Remove</button>
    </div>`;
    }

    document.addEventListener('DOMContentLoaded', function () {
        const container = document.getElementById('itemsContainer');
        const addBtn = document.getElementById('addMoreBtn');

        function addItem() {
            container.insertAdjacentHTML('beforeend', createItemForm(itemIndex++));
        }

        addBtn.addEventListener('click', addItem);
        container.addEventListener('click', function (e) {
            if (e.target.classList.contains('remove-item-btn')) {
                e.target.closest('.item-block').remove();
            }
        });

        // Add the first item block by default
        addItem();

        function handleImagePreview(input) {
            const file = input.files[0];
            const preview = input.closest('.form-group').querySelector('.img-preview');

            if (file && preview) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        document.addEventListener('change', function (e) {
            if (e.target.classList.contains('image-input')) {
                handleImagePreview(e.target);
            }
        });
    });



</script>
{% endblock javascripts %}